@page "/"
@using WhyNotLang.Interpreter
@using WhyNotLang.Interpreter.Evaluators.ExpressionValues
@using WhyNotLang.Tokenizer;

@inject IExecutor Executor
@inject IJSRuntime JsRuntime

<h1>Hello, world!</h1>


<textarea id="main_text" @bind="@programCode" readonly="@isRunning" class="form-control" rows="10">
</textarea>
<p>
    <button class="btn btn-primary" @onclick="Toggle">Toggle variable</button>
    <button class="btn btn-primary" @onclick="Execute">Execute</button>
    <button class="btn btn-primary" @onclick="Stop">Stop</button>
</p>

<textarea id="output" @bind="@output" readonly="readonly" class="form-control" rows="10">
</textarea>

@code {
    bool toggle = false;
    bool isRunning { get; set; } = false;
    public string output { get; set; } = "";
    public string programCode { get; set; } =
@"var x:= 0
while (x < 100)
begin
Writeln(""Line: "" + ToString(x) + "", Toggle value: "" + ToString(toggle))
x := x+1
Delay(100)
end
";

    protected override async Task OnInitAsync()
    {
        Executor.ProgramState.BuiltinFunctionCollection.Add("Writeln",
            async arguments =>
            {
                var str = arguments.Single();
                if (str.Type != ExpressionValueTypes.String)
                {
                    throw new Exception("String expected");
                }

                output += str.Value + Environment.NewLine;
                this.StateHasChanged();
                await JsRuntime.InvokeAsync<string>("WhyNotLang.scrollOutput");
                return ExpressionValue.Empty;
            });
    }

    void Stop()
    {
        Executor.Stop();
    }

    void Toggle()
    {
        toggle = !toggle;
        Executor.ProgramState.AssignVariable("toggle", new ExpressionValue(IntToBool(toggle), ExpressionValueTypes.Number));
    }

    async Task Execute()
    {
        output = "";
        Executor.ProgramState.Clear();
        isRunning = true;
        try
        {
            Executor.Initialise(programCode);
            Executor.ProgramState.DeclareVariable("toggle", new ExpressionValue(IntToBool(toggle), ExpressionValueTypes.Number), true);

            await Executor.ExecuteAll();
        }
        catch (WhyNotLangException ex)
        {
            if (ex.LineNumber > 0)
            {
                output += $"[ERROR] Line {ex.LineNumber}: {ex.Message}";
            }
            else
            {
                output += $"[ERROR] {ex.Message}";
            }
        }


        isRunning = false;
    }

    private int IntToBool(bool val)
    {
        return val ? 1 : 0;
    }
}